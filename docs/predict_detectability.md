# DeepDIA Tutorial: Spectral Library Generation with Detectability Prediction
Using deep learning to generate in silico spectral libraries from proteome databases with detectability filtering for data-independent acquisition (DIA) analysis. 

## 1. Prerequisites
See [**DeepDIA Tutorial: Spectral Library Generation From Peptide Lists**](predict_msms_irt.md).

For spectral library generation from FASTA files, the following package is required:
- [Biopython](https://biopython.org/) (version 1.70 or later)

## 2. Tutorial Data
### 2.1. Starting Materials for Spectral Library Generation
Starting materials of this tutorial are available at ProteomeXchange and iProX with identifier [`PXD014108`](http://proteomecentral.proteomexchange.org/cgi/GetDataset?ID=PXD014108) or [`IPX0001628000`](https://www.iprox.cn/page/project.html?id=IPX0001628000). 

#### 2.1.1. Models for MS/MS, iRT and Detectability Prediction
Pre-trained models: 
- HeLa.model.zip
- HeLa_HEK293.model.zip

They are also provided in [`data\models`](data/models) folder in this repositry.

The models have been trained with HeLa and HEK-293 data on Q Exactive HF (Bruderer, R. et al. Mol. Cell. Proteomics 2017, 16, 2296-2309, [doi:10.1074/mcp.RA117.000314](https://doi.org/10.1074/mcp.RA117.000314)).

#### 2.1.2. Protein Sequence Database
SwissProt *Homo sapiens* database (FASTA) can be downloaded from [UniProt](https://www.uniprot.org/). The FASTA file (2018-04 version, 20,301 entries)
has been deposited to ProteomeXchange via the iProX partner repository with the data set identifier [`PXD014108`](http://proteomecentral.proteomexchange.org/cgi/GetDataset?ID=PXD014108) or [`IPX0001628000`](https://www.iprox.cn/page/project.html?id=IPX0001628000). 
- swissprot_human_201804_validated.fasta


### 2.2. Tutorial Data for DIA Analysis
These files are not needed in the process of spectral library generation, but are used in the complete DIA data analysis workflow.

LC-MS/MS data of 3 DIA technical replicates of 2 h gradient of HeLa cells on Q Exactive HF are available at ProteomeXchange with the data set [`PXD005573`](http://proteomecentral.proteomexchange.org/GetDataset?ID=PXD005573) (Bruderer, R. et al. Mol. Cell. Proteomics 2017, 16, 2296-2309, [doi:10.1074/mcp.RA117.000314](https://doi.org/10.1074/mcp.RA117.000314)).
- Fig1_MP-DIA-120min120kMS1-22W30k-8dppp_MHRM_R01.raw
- Fig1_MP-DIA-120min120kMS1-22W30k-8dppp_MHRM_R02.raw
- Fig1_MP-DIA-120min120kMS1-22W30k-8dppp_MHRM_R03.raw


## 3. Spectral Library Generation
### 3.1. Prepare Starting Materials
Create a directory for the project. Place the FASTA and models in the project folder in the following paths:
- swissprot_human_201804_validated.fasta
- models\charge2\epoch_035.hdf5
- models\charge3\epoch_034.hdf5
- models\irt\epoch_082.hdf5
- models\detectability\epoch_004.hdf5

Open Anaconda PowerShell Prompt, set the project folder as working directory, and set path to the scripts as global parameter.
``` powershell
cd "Path_to_project_data"
$script_path = "Path_to_DeepDIA\src"
```

### 3.1. Protein Digestion
A peptide list can been generated by in silico digestion from protein sequences (FASTA). Protein digestion can be performed using `digest_proteins.py`.

``` powershell
python $script_path\digest_proteins.py `
--in swissprot_human_201804_validated.fasta `
--out swissprot_human_201804_validated.peptide.csv `
--no-group_duplicated
```

By default, `Trypsin/P` is selected as enzyme and digestion is performed with the following parameters:
- Maximum missed cleavages: 2
- Minimum peptide length: 7
- Maximum peptide length: 50
- Minimum peptide mass: 0
- Maximum peptide mass: 4000
- Remove N-terminal methionine: True

You can the view the parameters using the following command:
``` powershell
python $script_path\digest_proteins.py --help
```

The peptide list file is generated in the working directory.
- swissprot_human_201804_validated.peptide.csv

If the output file is too large to process in subsequent steps (e.g., out of memory), you can set `--split_miss` to split peptides to separate files according to numbers of missed cleavages.

### 3.2. Predict MS Detectability
Run `predict_detectability.py` to predict MS detectability of the digested peptides.
``` powershell
python $script_path\predict_detectability.py `
--in swissprot_human_201804_validated.peptide.csv `
--model models\detectability\epoch_004.hdf5 `
--out swissprot_human_201804_validated.prediction.detectability.csv
```

The detectability file is generated in the working directory.
- swissprot_human_201804_validated.prediction.detectability.csv

In this demo, peptides with detectability score < 0.5 are ruled out.

``` powershell
python $script_path\filter_peptide_by_detectability.py `
--peptide swissprot_human_201804_validated.peptide.csv `
--detect swissprot_human_201804_validated.prediction.detectability.csv `
--out swissprot_human_201804_validated_detectability50.peptide.csv `
--min_detectability 0.5
```

The filtered peptide list file is generated in the working directory.
- swissprot_human_201804_validated_detectability50.peptide.csv

### 3.3 Generate Spectral Library
Follow the instruction described in [**DeepDIA Tutorial: Spectral Library Generation From Peptide Lists**](predict_msms_irt.md) to predict MS/MS spectra and iRT, and generate a spectral library.

``` powershell
python $script_path\predict_ms2.py `
--in swissprot_human_201804_validated_detectability50.peptide.csv `
--model models\charge2\epoch_035.hdf5 `
--charge 2 `
--out swissprot_human_201804_validated_detectability50_charge2.prediction.ions.json

python $script_path\predict_ms2.py `
--in swissprot_human_201804_validated_detectability50.peptide.csv `
--model models\charge3\epoch_034.hdf5 `
--charge 3 `
--out swissprot_human_201804_validated_detectability50_charge3.prediction.ions.json

python $script_path\predict_rt.py `
--in swissprot_human_201804_validated_detectability50.peptide.csv `
--model models\irt\epoch_082.hdf5 `
--out swissprot_human_201804_validated_detectability50.prediction.irt.csv

python $script_path\build_assays_from_prediction.py `
--peptide swissprot_human_201804_validated_detectability50.peptide.csv `
--ions swissprot_human_201804_validated_detectability50_charge2.prediction.ions.json `
       swissprot_human_201804_validated_detectability50_charge3.prediction.ions.json `
--rt swissprot_human_201804_validated_detectability50.prediction.irt.csv `
--out swissprot_human_201804_validated_detectability50.prediction.assay.pickle

python $script_path\convert_assays_to_Spectronaut_library.py `
--in swissprot_human_201804_validated_detectability50.prediction.assay.pickle `
--out swissprot_human_201804_validated_detectability50.prediction.library.csv
```

The generated spectral library is saved as a CSV file that is compatible with Spectronaut.
- swissprot_human_201804_validated_detectability50.prediction.library.csv


## 4. DIA Data Analysis
The predicted spectral library (`swissprot_human_201804_validated_detectability50.prediction.library.csv`) can be imported into Spectronaut with the FASTA file (`swissprot_human_201804_validated.fasta`) to analyze the DIA raw data.

For DIA analysis using large spectral libraries, it is recommanded to set the `Machine Learning` parameter to `Across Experiment`.

For detailed instructions, see [Spectronaut Manual](https://biognosys.com/resources/spectronaut-manual
).

For benchmarking purpose, the entrapment strategy can be used to evaluate identification error rates by adding proteins from other organisms to the libraries. The entrapment protein sequence databases are available at ProteomeXchange abd iProX with identifier identifier [`PXD014108`](http://proteomecentral.proteomexchange.org/cgi/GetDataset?ID=PXD014108) or [`IPX0001628000`](https://www.iprox.cn/page/project.html?id=IPX0001628000). 
- swissprot_Caenorhabditis_elegans_201903.fasta
- swissprot_Dictyostelium_discoideum_201903.fasta
- swissprot_Escherichia_coli_strain_K12_201903.fasta
- swissprot_Saccharomyces_cerevisiae_strain_ATCC_204508_S288c_201903.fasta

Spectral libraries can be generated from the entrapment sequences using the same method as the human library described above.
